import speech_recognition as sr
from pathlib import Path
from dispatcher import bot
import os


async def download_voice(bot, file , file_name: str, path: str) ->bool:
    Path(f"{path}").mkdir(parents=True, exist_ok=True)
    await bot.download_file(file_path=file.file_path, destination=f"{path}/{file_name}")


async def transcibeVoice(voice):
	path = "download/voices/"
	await download_voice(file=voice,
					file_name=f"{voice.file_id}.ogg",
					path=path)
	os.system(f"ffmpeg -i download/voices/{voice.file_id}.ogg download/voices/{voice.file_id}.wav")


async def recognize_voice(voice) -> str:
    await transcibeVoice(voice)
    try:
        r = sr.Recognizer()
        with sr.WavFile(f"download/voices/{id}.wav") as source:
            r.adjust_for_ambient_noise(source) # Optional
            audio = r.record(source)
        text = r.recognize_google(audio, language="ru-RU")
        os.remove('download/voices/{}.ogg'.format(voice.file_id))
        os.remove('download/voices/{}.wav'.format(voice.file_id))
        return text
    except sr.UnknownValueError:
        return "Ошибка распознавания."
    except sr.RequestError as e:
        return "Could not request results from Speech to Text service"
